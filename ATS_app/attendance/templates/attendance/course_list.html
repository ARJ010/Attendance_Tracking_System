{% extends 'base.html' %}

{% block title %}Course List{% endblock %}

{% block content %}
{% if messages %}
  <div class="alert alert-warning">
    {% for message in messages %}
      <p>{{ message }}</p>
    {% endfor %}
  </div>
{% endif %}
    <h2>Department of {{ department }} (Courses)</h2>
    {% if is_hod %}
    <div class="mb-3">
        <a href="{% url 'add_course' %}" class="btn btn-primary">Add Course</a>
    </div>
    {% endif %}
    <table class="table">
        <thead>
          <tr>
            <th>Course Name</th>
            <th>Course Code</th>
            <th>Department</th>
            <th>Actions</th>
            <th>Reports</th>
          </tr>
        </thead>
        <tbody>
          {% for course in courses %}
            <tr>
              <td>{{ course.name }}</td>
              <td>{{ course.code }}</td>
              <td>{{ course.department.name }}</td>
              <td>
                <button type="button" class="btn btn-info show-btn" data-course="{{ course.id }}">Show Students</button>
                <a href="{% url 'take_attendance' course.id %}"> <button type="button" class="btn btn-info">Take Attendance</button></a>
            </td>
            <td>
              <div class="mb-3">
                <a href="{% url 'attendance_report' course.id %}" class="btn btn-success">Summary Report</a>
              </div>            
            </td>
            </tr>
          {% empty %}
            <tr>
                <td colspan="5">No courses found.</td>
            </tr>
          {% endfor %}
        </tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="studentsModal" tabindex="-1" aria-labelledby="studentsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="studentsModalLabel">Assigned Students</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ol id="studentList">
              <!-- Assigned students will be shown here -->
            </ol>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const buttons = document.querySelectorAll('.show-btn');

      buttons.forEach(button => {
          button.addEventListener('click', function () {
              const courseId = button.getAttribute('data-course');

              // Fetch the students assigned to this course using AJAX
              fetch(`/get_assigned_students/${courseId}/`)
                  .then(response => response.json())
                  .then(data => {
                      const studentList = document.getElementById('studentList');
                      studentList.innerHTML = ''; // Clear previous list

                      if (data.students.length > 0) {
                          data.students.forEach(student => {
                              const listItem = document.createElement('li');
                              listItem.innerHTML = `
                                  ${student.name} (${student.university_register_number}, ${student.programme})`;
                              studentList.appendChild(listItem);
                          });
                      } else {
                          const listItem = document.createElement('li');
                          listItem.textContent = 'No students assigned';
                          studentList.appendChild(listItem);
                      }
                  })
                  .catch(error => {
                      console.error("Error fetching students:", error);
                      alert("Failed to fetch assigned students. Please try again.");
                  });

              // Show the modal
              const modal = new bootstrap.Modal(document.getElementById('studentsModal'));
              modal.show();
          });
      });
  });
</script>

{% endblock %}
